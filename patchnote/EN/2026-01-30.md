# Portfolio optimization, scalability, and security

This update applies a major technical cleanup: less duplicated code, a more robust API, a rate limit shared across instances, and strengthened security across the entire site and API routes.

Date: January 30, 2026

## Code optimization (DRY)

### GitHub types and constants

- **RepoParam**: the **{ owner, name }** type was defined three times across the multi-stats, multi-timeline, and multi-commits routes. It is now defined once in **lib/github/types.ts** and reused everywhere.
- **Valid time ranges**: the list **['7d', '30d', '6m', '12m']** was duplicated in more than seven places (API routes, components, utils). A single constant, **VALID_TIME_RANGES**, is now the reference for both validation and display.
- **Start date of a range**: the same logic existed twice (**getStartDate** in db-queries and **getStartDateForRange** in utils). Everything now goes through **getStartDateForRange** to avoid any divergence.

> Why: a single place to update when adding or changing a range, and fewer chances for errors.

### Parsing multi-repo route parameters

- The three routes (multi-stats, multi-timeline, multi-commits) repeated the same block: reading **repos**, **range**, **locale**, validating the range, parsing repos JSON, falling back to allowed repositories, and filtering valid repos.
- A single function, **parseMultiRepoQueryParams**, in **lib/github/route-params.ts**, centralizes this logic and returns either validated parameters or a 400 error response.

> Why: a rule change (e.g. new validation) is applied in one place only.

### Secured API responses

- Each route manually wrapped responses with **addSecurityHeaders** and remaining rate-limit information, leading to duplicated code and potential omissions.
- A helper, **createJsonResponse(data, options, securityCheck)**, now consistently applies security headers and remaining rate-limit information.

> Why: consistent responses and less risk of forgetting a header.

### Section navigation bars

- The four navbars (Stats, FAQ, Games, Projects) shared the same structure: fixed bar, logo/avatar, links (Home, FAQ, Stats, Games), settings, mobile menu.
- A shared **SectionNavigation** component now receives the list of links and the mobile menu component. Each page (Stats, FAQ, etc.) only provides its links and menu.

> Why: a style or structure change to the bar is done once.

### Cleanup

- Removal of an empty block in multi-commits (condition **if (allCommits.length === 0)** with no body).
- Allowed origins (CORS): now configurable via the **ALLOWED_ORIGINS** or **NEXT_PUBLIC_SITE_URL** environment variables, with a fallback to a default list.
- Time range labels in types: replaced with neutral keys; user-facing display remains handled by i18n (translations for 7 days, 30 days, etc.).

---

## Scalability

### GitHub API rate limiting

- GitHub routes (multi-stats, multi-timeline, multi-commits, etc.) previously used an **in-memory Map** for rate limiting. In multi-instance or serverless setups, each instance had its own counter, resulting in no global limit.
- The rate limit now relies on **Redis** (as with email) when available, with an in-memory fallback otherwise. The limit is shared across all instances.

> Why: in production with multiple instances, the number of requests per IP is properly limited.

---

## Security

### Client IP extraction

- IP extraction logic (cf-connecting-ip, x-forwarded-for, x-real-ip) was duplicated in **lib/github/security.ts** and **lib/rate-limit.ts**.
- A single **getClientIP(request)** function in **lib/request-utils.ts** is now used by both GitHub security and email rate limiting.

> Why: a single source of truth for client identification.

### Centralized API errors

- Error messages across routes mixed French and English and were scattered in individual files.
- A **lib/github/errors.ts** module now centralizes error codes, messages (in English for the API), and HTTP statuses. Routes use **apiError('CODE', options)** to return consistent error responses.

> Why: a more professional API and easier maintenance.

### Parameter validation

- **Multi-repo routes**: maximum **repos** parameter size (4 KB), maximum number of repositories (20), strict format for **owner** and **name** (alphanumeric, dash, underscore, 1–100 characters). Locale is limited to **fr** or **en**.
- **Patchnotes API**: validation of the **id** to prevent path traversal. Only identifiers like **FR/2026-01-30** or **EN/2026-01-30** are accepted; the resolved path is verified to stay within the patchnotes directory.
- **Commit search**: the **q** search parameter is limited to 128 characters.
- **GitHub webhook**: maximum body size of 1 MB (413 response if exceeded). HMAC signature verification with length comparison before **timingSafeEqual** to prevent timing attacks. Shared use of **getClientIP** for GitHub IP verification.

### Site security headers

- Added a **Content-Security-Policy** in the Next.js config: restricted default sources, forms, frames, images, and scripts, with explicit allowances for Turnstile (Cloudflare) and EmailJS.

> Why: reduce XSS attack surface and unwanted resource loading.

---

## Chart: 7-day and 30-day ranges only

### Context

- Over 6 months and 12 months, the commit activity chart had display issues: tooltip showing 0 on hover, hover line misaligned with month labels, poor readability.
- Over 7 days and 30 days, rendering and hover behavior remain correct.

### Changes

- **Chart**: the chart’s time-range selector (above the curve) now only offers **7 days** and **30 days**. A **CHART_TIME_RANGES** constant = **['7d', '30d']** is used exclusively for this selector.
- **Global stats**: the stats time-range selector (commits, lines, contributors, etc.) keeps **7 days, 30 days, 6 months, and 12 months** (**VALID_TIME_RANGES**). The default remains **12 months**.
- **Commit search**: the search time-range selector keeps **7 days, 30 days, 6 months, and 12 months**.

> Why: keep 6m and 12m where they are useful (numbers and search), and avoid chart display bugs by limiting the curve to 7d and 30d.

---

## Technical summary

| Area                 | Files / impacted areas                                                                 |
|----------------------|----------------------------------------------------------------------------------------|
| Types / constants    | **lib/github/types.ts**, **utils.ts**, **db-queries.ts**, multi-* API routes, PeriodSelector, stats page |
| Params / security    | **lib/github/route-params.ts**, **security.ts**, GitHub API routes, patchnotes          |
| Rate limit / IP      | **lib/github/security.ts**, **lib/rate-limit.ts**, **lib/request-utils.ts**             |
| API errors           | **lib/github/errors.ts**, all related API routes                                        |
| Navbars              | **SectionNavigation.tsx**, StatsNavigation, FAQNavigation, GamesNavigation, ProjectsNavigation |
| Security             | **next.config.ts** (CSP), patchnotes id/lang/sort validation, webhook, **q** limit      |
| Chart                | **CHART_TIME_RANGES** in types, stats page (chart selector only)                        |

---

## For the user

- **No change in usage**: you still choose your repositories and time ranges for stats and commit search as before.
- **Chart**: above the chart, only “7 days” and “30 days” are available for clean rendering; global stats and commit search keep 6 months and 12 months.
- **Security**: the APIs and site apply stronger validations and headers without changing the normal usage flow.