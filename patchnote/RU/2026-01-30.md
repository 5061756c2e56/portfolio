# Оптимизация, масштабируемость и безопасность портфолио

Это обновление — большое техническое «уборочное» обслуживание: меньше дублирования кода, более надёжный API, общий rate limit между инстансами и усиление безопасности по всему сайту и API-роутам.

Дата: 30 января 2026

## Оптимизация кода (DRY)

### Типы и константы GitHub

- **RepoParam**: тип **{ owner, name }** был определён три раза в роутерах multi-stats, multi-timeline и multi-commits. Теперь он определён один раз в **lib/github/types.ts** и переиспользуется везде.
- **Допустимые периоды**: список **['7d', '30d', '6m', '12m']** копировался более чем в семи местах (API-роуты, компоненты, utils). Теперь одна константа **VALID_TIME_RANGES** служит единственным источником для валидации и отображения периодов.
- **Дата начала диапазона**: одинаковая логика была продублирована (**getStartDate** в db-queries и **getStartDateForRange** в utils). Теперь всё проходит через **getStartDateForRange**, чтобы избежать расхождений.

> Почему: одно место для изменений (если добавить/поменять период) и меньше риска ошибок.

### Парсинг параметров роутов для multi-repo

- Три роута (multi-stats, multi-timeline, multi-commits) повторяли один и тот же блок: чтение **repos**, **range**, **locale**, валидация range, JSON-парсинг repos, fallback на разрешённые репозитории, фильтрация валидных репозиториев.
- Одна функция **parseMultiRepoQueryParams** в **lib/github/route-params.ts** централизует эту логику и возвращает либо валидированные параметры, либо ошибку 400.

> Почему: изменение правил (например, новая валидация) делается в одном месте.

### Безопасные ответы API

- Каждый роут вручную оборачивал ответы через **addSecurityHeaders** и добавлял оставшийся rate limit, что увеличивало риск пропусков и порождало повторяющийся код.
- Хелпер **createJsonResponse(data, options, securityCheck)** систематически применяет security headers и возвращает оставшийся rate limit.

> Почему: единообразные ответы и меньше шансов забыть заголовок.

### Навигационные панели разделов

- Четыре navbars (Stats, FAQ, Games, Projects) имели одинаковую структуру: фиксированная панель, лого/аватар, ссылки (Home, FAQ, Stats, Games), настройки, мобильное меню.
- Общий компонент **SectionNavigation** принимает список ссылок и компонент мобильного меню. Каждая страница (Stats, FAQ и т. д.) использует его, передавая только свои ссылки и меню.

> Почему: изменение стиля или структуры панели делается один раз.

### Очистка

- Удалён пустой блок в multi-commits (условие **if (allCommits.length === 0)** без тела).
- Разрешённые origin’ы (CORS): возможность конфигурации через переменные окружения **ALLOWED_ORIGINS** или **NEXT_PUBLIC_SITE_URL**, с fallback на список по умолчанию.
- Лейблы периодов в типах: заменены на нейтральные ключи; пользовательское отображение остаётся через i18n (переводы «7 дней», «30 дней» и т. д.).

---

## Масштабируемость

### Rate limit для GitHub API

- Rate limit GitHub-роутов (multi-stats, multi-timeline, multi-commits и т. д.) использовал **Map в памяти**. В multi-instance или serverless окружении у каждого инстанса был свой счётчик, то есть глобального лимита не было.
- Теперь rate limit опирается на **Redis** (как и для email), если Redis доступен; иначе — fallback в память. Лимит общий для всех инстансов.

> Почему: в продакшене с несколькими инстансами количество запросов на IP ограничивается корректно.

---

## Безопасность

### Извлечение IP клиента

- Логика извлечения IP (cf-connecting-ip, x-forwarded-for, x-real-ip) была продублирована в **lib/github/security.ts** и **lib/rate-limit.ts**.
- Одна функция **getClientIP(request)** в **lib/request-utils.ts** используется и для GitHub security, и для email rate limit.

> Почему: единый источник истины для идентификации клиента.

### Централизованные API-ошибки

- Сообщения об ошибках в роутах смешивали французский и английский и были размазаны по файлам.
- Модуль **lib/github/errors.ts** централизует коды, сообщения (на английском для API) и HTTP-статусы. Роуты используют **apiError('CODE', options)** для согласованных ошибок.

> Почему: более «профессиональный» API и проще поддержка.

### Валидация параметров

- **Multi-repo роуты**: максимум 4 КБ для параметра **repos**, максимум 20 репозиториев, строгий формат **owner** и **name** (alphanum, дефис, underscore, 1–100 символов). Локаль ограничена **fr** или **en**.
- **API Patchnotes**: валидация **id** для защиты от обхода путей (path traversal). Принимаются только идентификаторы вида **FR/2026-01-30** или **EN/2026-01-30**; вычисленный путь проверяется, чтобы оставаться внутри папки patchnotes.
- **Поиск коммитов**: параметр поиска **q** ограничен 128 символами.
- **Webhook GitHub**: максимальный размер body — 1 МБ (ответ 413 при превышении). Проверка подписи HMAC с предварительной проверкой длины перед **timingSafeEqual**, чтобы снизить утечки по времени. Используется общий **getClientIP** для проверки IP GitHub.

### Заголовки безопасности сайта

- Добавлена **Content-Security-Policy** в конфигурацию Next.js: ограничения источников по умолчанию, форм, iframe’ов, изображений и скриптов, с явным разрешением для Turnstile (Cloudflare) и EmailJS.

> Почему: уменьшить поверхность атаки XSS и нежелательные загрузки.

---

## График: только периоды 7 и 30 дней

### Контекст

- На периодах 6 месяцев и 12 месяцев график активности коммитов давал проблемы отображения: tooltip показывал 0 при наведении, линия наведения была смещена относительно месяцев снизу, общий рендер становился плохо читаемым.
- На 7 днях и 30 днях отображение и наведение остаются корректными.

### Изменения

- **График**: селектор периода графика (над кривой) теперь предлагает только **7 дней** и **30 дней**. Константа **CHART_TIME_RANGES** = **['7d', '30d']** используется только для этого селектора.
- **Общая статистика**: селектор периода для статистик (коммиты, строки, участники и т. д.) сохраняет **7 дней, 30 дней, 6 месяцев и 12 месяцев** (**VALID_TIME_RANGES**). Значение по умолчанию — **12 месяцев**.
- **Поиск коммитов**: селектор периода поиска сохраняет **7 дней, 30 дней, 6 месяцев и 12 месяцев**.

> Почему: оставить 6m и 12m там, где они полезны (цифры и поиск), и убрать баги графика, предлагая для кривой только 7d и 30d.

---

## Техническое резюме

| Область              | Затронутые файлы / зоны                                                                 |
|----------------------|------------------------------------------------------------------------------------------|
| Типы / константы     | **lib/github/types.ts**, **utils.ts**, **db-queries.ts**, multi-* API routes, PeriodSelector, stats page |
| Параметры / безопасность | **lib/github/route-params.ts**, **security.ts**, GitHub API routes, patchnotes              |
| Rate limit / IP      | **lib/github/security.ts**, **lib/rate-limit.ts**, **lib/request-utils.ts**              |
| API-ошибки           | **lib/github/errors.ts**, все соответствующие API-роуты                                  |
| Navbars              | **SectionNavigation.tsx**, StatsNavigation, FAQNavigation, GamesNavigation, ProjectsNavigation |
| Безопасность         | **next.config.ts** (CSP), валидация id/lang/sort patchnotes, webhook, лимит **q**        |
| График               | **CHART_TIME_RANGES** в types, stats page (только селектор графика)                       |

---

## Для пользователя

- **С точки зрения использования ничего не меняется**: ты по-прежнему выбираешь репозитории и периоды для статистики и поиска коммитов как раньше.
- **График**: над графиком доступны только «7 дней» и «30 дней» для чистого отображения; общая статистика и поиск коммитов сохраняют 6 месяцев и 12 месяцев.
- **Безопасность**: API и сайт применяют усиленные валидации и заголовки, не меняя обычный пользовательский сценарий.
