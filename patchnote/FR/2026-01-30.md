# Optimisation, scalabilité et sécurité du portfolio

Cette mise à jour applique un grand nettoyage technique : moins de code dupliqué, une API plus robuste, un rate limit partagé entre instances, et un renforcement de la sécurité sur tout le site et les routes API.

Date : 30 janvier 2026

## Optimisation du code (DRY)

### Types et constantes GitHub

- **RepoParam** : le type **{ owner, name }** était défini en triple dans les routes multi-stats, multi-timeline et multi-commits. Il est désormais défini une seule fois dans **lib/github/types.ts** et réutilisé partout.
- **Périodes valides** : la liste **['7d', '30d', '6m', '12m']** était recopiée dans plus de sept endroits (routes API, composants, utils). Une seule constante **VALID_TIME_RANGES** sert désormais de référence pour la validation et l’affichage des périodes.
- **Date de début d’une plage** : la même logique existait en double (**getStartDate** dans db-queries et **getStartDateForRange** dans utils). Tout passe par **getStartDateForRange** pour éviter toute divergence.

> Pourquoi : un seul endroit à modifier si on ajoute ou change une période, et moins de risque d’erreur.

### Parsing des paramètres des routes multi-repos

- Les trois routes (multi-stats, multi-timeline, multi-commits) répétaient le même bloc : lecture de **repos**, **range**, **locale**, validation du range, parsing JSON des repos, fallback vers les dépôts autorisés, filtre des repos valides.
- Une fonction unique **parseMultiRepoQueryParams** dans **lib/github/route-params.ts** centralise cette logique et retourne soit les paramètres validés, soit une réponse d’erreur 400.

> Pourquoi : une modification de règle (ex. nouvelle validation) se fait à un seul endroit.

### Réponses API sécurisées

- Chaque route enveloppait manuellement les réponses avec **addSecurityHeaders** et le rate-limit restant, ce qui multipliait les oublis et le code répétitif.
- Un helper **createJsonResponse(data, options, securityCheck)** applique systématiquement les en-têtes de sécurité et le rate-limit restant.

> Pourquoi : réponses homogènes et moins de risque d’oublier un header.

### Barres de navigation des sections

- Les quatre navbars (Stats, FAQ, Jeux, Projets) avaient la même structure : barre fixe, logo/avatar, liens (Accueil, FAQ, Stats, Jeux), paramètres, menu mobile.
- Un composant commun **SectionNavigation** reçoit la liste de liens et le composant de menu mobile. Chaque page (Stats, FAQ, etc.) l’utilise en ne fournissant que ses liens et son menu.

> Pourquoi : un changement de style ou de structure de la barre se fait une seule fois.

### Nettoyage

- Suppression du bloc vide dans multi-commits (condition **if (allCommits.length === 0)** sans corps).
- Origines autorisées (CORS) : possibilité de les configurer via les variables d’environnement **ALLOWED_ORIGINS** ou **NEXT_PUBLIC_SITE_URL**, avec repli sur une liste par défaut.
- Labels des périodes dans les types : remplacés par des clés neutres ; l’affichage utilisateur reste géré par l’i18n (traductions 7 jours, 30 jours, etc.).

---

## Scalabilité

### Rate limit des API GitHub

- Le rate limit des routes GitHub (multi-stats, multi-timeline, multi-commits, etc.) utilisait un **Map en mémoire**. En multi-instances ou en serverless, chaque instance avait son propre compteur, donc pas de limite globale.
- Le rate limit s’appuie désormais sur **Redis** (comme pour l’email) quand Redis est disponible, avec repli en mémoire sinon. La limite est partagée entre toutes les instances.

> Pourquoi : en production avec plusieurs instances, le nombre de requêtes par IP est correctement limité.

---

## Sécurité

### Extraction de l’IP client

- La logique d’extraction de l’IP (cf-connecting-ip, x-forwarded-for, x-real-ip) était dupliquée dans **lib/github/security.ts** et **lib/rate-limit.ts**.
- Une seule fonction **getClientIP(request)** dans **lib/request-utils.ts** est utilisée par la sécurité GitHub et par le rate limit email.

> Pourquoi : une seule source de vérité pour l’identification du client.

### Erreurs API centralisées

- Les messages d’erreur des routes mélangeaient français et anglais et étaient éparpillés dans chaque fichier.
- Un module **lib/github/errors.ts** centralise les codes, messages (en anglais pour l’API) et statuts HTTP. Les routes utilisent **apiError('CODE', options)** pour renvoyer des réponses d’erreur cohérentes.

> Pourquoi : API plus professionnelle et maintenance plus simple.

### Validation des paramètres

- **Routes multi-repos** : taille max du paramètre **repos** (4 Ko), nombre max de dépôts (20), format strict pour **owner** et **name** (alphanum, tiret, underscore, 1–100 caractères). La locale est limitée à **fr** ou **en**.
- **API Patchnotes** : validation de l’**id** pour empêcher la traversée de répertoires (path traversal). Seuls les identifiants du type **FR/2026-01-30** ou **EN/2026-01-30** sont acceptés ; le chemin résolu est vérifié pour rester dans le dossier des patchnotes.
- **Recherche de commits** : le paramètre de recherche **q** est limité à 128 caractères.
- **Webhook GitHub** : taille max du body à 1 Mo (réponse 413 si dépassement). Vérification de la signature HMAC avec comparaison des longueurs avant **timingSafeEqual** pour éviter les fuites par timing. Utilisation de **getClientIP** partagé pour la vérification des IP GitHub.

### En-têtes de sécurité du site

- Ajout d’une **Content-Security-Policy** dans la config Next.js : restriction des sources par défaut, des formulaires, des frames, des images et des scripts, avec autorisation explicite pour Turnstile (Cloudflare) et EmailJS.

> Pourquoi : réduire la surface d’attaque XSS et les chargements non désirés.

---

## Graphique : périodes 7 jours et 30 jours uniquement

### Contexte

- En 6 mois et 12 mois, le graphique d’activité des commits posait des problèmes d’affichage : tooltip à 0 au survol, ligne de survol décalée par rapport aux mois en bas, rendu peu lisible.
- En 7 jours et 30 jours, l’affichage et le survol restent corrects.

### Modifications

- **Graphique** : le sélecteur de période du graphique (au-dessus du courbe) n’offre plus que **7 jours** et **30 jours**. Une constante **CHART_TIME_RANGES** = **['7d', '30d']** est utilisée uniquement pour ce sélecteur.
- **Stats globales** : le sélecteur de période des stats (commits, lignes, contributeurs, etc.) conserve **7 jours, 30 jours, 6 mois et 12 mois** (**VALID_TIME_RANGES**). La valeur par défaut reste **12 mois**.
- **Recherche de commits** : le sélecteur de période de la recherche garde **7 jours, 30 jours, 6 mois et 12 mois**.

> Pourquoi : garder 6m et 12m là où ils sont utiles (chiffres et recherche), et éviter les bugs d’affichage sur le graphique en ne proposant que 7j et 30j pour la courbe.

---

## Résumé technique

| Domaine              | Fichiers / zones impactés                                                                 |
|----------------------|-------------------------------------------------------------------------------------------|
| Types / constantes   | **lib/github/types.ts**, **utils.ts**, **db-queries.ts**, routes API multi-*, PeriodSelector, stats page |
| Params / sécurité   | **lib/github/route-params.ts**, **security.ts**, routes API GitHub, patchnotes               |
| Rate limit / IP     | **lib/github/security.ts**, **lib/rate-limit.ts**, **lib/request-utils.ts**                     |
| Erreurs API         | **lib/github/errors.ts**, toutes les routes API concernées                                  |
| Navbars             | **SectionNavigation.tsx**, StatsNavigation, FAQNavigation, GamesNavigation, ProjectsNavigation |
| Sécurité            | **next.config.ts** (CSP), validation id/lang/sort patchnotes, webhook, limite **q**          |
| Graphique           | **CHART_TIME_RANGES** dans types, stats page (sélecteur du graphique uniquement)             |

---

## Pour l’utilisateur

- **Rien ne change côté usage** : tu choisis toujours tes dépôts, tes périodes pour les stats et la recherche de commits comme avant.
- **Graphique** : au-dessus du graphique, seules les options « 7 jours » et « 30 jours » sont proposées pour un affichage propre ; les stats globales et la recherche de commits gardent 6 mois et 12 mois.
- **Sécurité** : les API et le site appliquent des validations et des en-têtes renforcés, sans modifier le flux normal d’utilisation.
